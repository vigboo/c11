- hosts: all
  gather_facts: false
  vars:
    ssh_pubkey_path: /home/student/.ssh/id_rsa.pub
  tasks:
    - name: Read controller public key
      local_action: shell cat '{{ ssh_pubkey_path }}' || cat ~/.ssh/id_rsa.pub
      register: pub

    - name: Ensure .ssh directory exists
      raw: |
        mkdir -p ~/.ssh && chmod 700 ~/.ssh
      changed_when: false

    - name: Install controller public key for student
      raw: |
        AUTH=~/.ssh/authorized_keys
        touch "$AUTH" && chmod 600 "$AUTH"
        grep -qF "{{ pub.stdout }}" "$AUTH" || echo "{{ pub.stdout }}" >> "$AUTH"
      changed_when: false
